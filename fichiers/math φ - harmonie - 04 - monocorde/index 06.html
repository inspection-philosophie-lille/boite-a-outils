<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monocorde de Pythagore</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }
    #monochord-container {
      position: relative;
	  
	  
	  
	  
	  
	  
      width: 600px;
      height: 120px;
      background: #e0e0e0;
      border-radius: 10px;
      box-shadow: 5px 5px 10px #bebebe, -5px -5px 10px #ffffff;
      margin-bottom: 20px;
    }
    #string-svg {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 40px;
      z-index: 1;
      cursor: pointer;
      transform: translateY(-20px);
    }
    #bridge-svg {
      position: absolute;
      top: 50%;
      z-index: 10;
      cursor: move;
    }
    .disk {
      position: absolute;
      top: 50%;
      width: 10px;
      height: 10px;
      background: #333;
      border-radius: 50%;

	  
      transform: translateY(-5px);
      z-index: 2;
    }
    #left-disk {
	  left: -5px;
    }
    #right-disk {
      right: -5px;
    }
    #markers {
      position: absolute;
      top: 70%;
      width: 100%;
      height: 40px;
    }
    .marker {
      position: absolute;
      top: 0;
      width: 2px;
      height: 10px;
      background: #a0a0a0;
      border-radius: 1px;
    }
    .marker-label {
      position: absolute;
      top: 15px;
      font-size: 12px;
      text-align: center;
      transform: translateX(-50%);
      color: #555;
    }
    .interval-label {
      position: absolute;
      top: 25px;
      left: 10px; /* Décalage pour aligner à droite */
      font-size: 10px;
	  margin-top: 40px;
      text-align: right;
      transform: translateX(-50%) rotate(-45deg); /* Inclinaison de 45° vers la droite */
      color: #555;
      width: 80px; /* Augmenté pour les longs noms */
      white-space: nowrap;
    }
    #info {
      margin-top: 85px;
      font-size: 16px;
      color: #333;
      background: #e0e0e0;
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: inset 3px 3px 6px #bebebe, inset -3px -3px 6px #ffffff;
    }
  </style>
</head>
<body>
  <h1>Monocorde de Pythagore</h1>
  <div id="monochord-container">
    <svg id="string-svg" width="600" height="40">
      <path id="string-path" d="M0 20 H600" stroke="#4d4d4d" stroke-width="4" fill="none"/> <!-- Grise foncée -->
    </svg>
    <svg id="bridge-svg" width="24" height="21">
      <polygon points="12,0 0,20.78 24,20.78" fill="red" stroke="none"/>
    </svg>
    <div id="left-disk" class="disk"></div>
    <div id="right-disk" class="disk"></div>
    <div id="markers"></div>
  </div>
  <div id="info">Position du chevalet : 100% (Corde entière - Do)</div>

  <script>
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    let bridgeSvg = document.getElementById('bridge-svg');
    let container = document.getElementById('monochord-container');
    let stringSvg = document.getElementById('string-svg');
    let stringPath = document.getElementById('string-path');
    let info = document.getElementById('info');
    let markers = document.getElementById('markers');
    let isDragging = false;
    const stringLength = 600;
    const baseFreq = 261.63;
    const snapStep = stringLength / 12; // 50px par cran
    let animationFrame;

    // Intervalles pythagoriciens pour les marqueurs
    const intervals = {
      '1/12': 'Neuvième mineure',
      '2/12': 'Seconde majeure',
      '3/12': 'Tierce mineure',
      '4/12': 'Tierce majeure',
      '5/12': 'Quarte',
      '6/12': 'Octave',
      '7/12': 'Quinte',
      '8/12': 'Sixte mineure',
      '9/12': 'Sixte majeure',
      '10/12': 'Septième mineure',
      '11/12': 'Septième majeure'
    };

    // Créer les marqueurs pour les 12 divisions avec intervalles sur une deuxième ligne
    for (let i = 1; i <= 11; i++) {
      let marker = document.createElement('div');
      marker.className = 'marker';
      marker.style.left = `${(i / 12) * 100}%`;
      markers.appendChild(marker);

      let fractionLabel = document.createElement('div');
      fractionLabel.className = 'marker-label';
      fractionLabel.style.left = `${(i / 12) * 100}%`;
      let fraction = `${i}/12`;
      fractionLabel.textContent = fraction;
      markers.appendChild(fractionLabel);

      let intervalLabel = document.createElement('div');
      intervalLabel.className = 'interval-label';
      intervalLabel.style.left = `${(i / 12) * 100}%`;
      intervalLabel.textContent = intervals[fraction] || '';
      markers.appendChild(intervalLabel);
    }

    // Gestion du déplacement du chevalet par crans
    bridgeSvg.addEventListener('mousedown', () => {
      isDragging = true;
    });

    document.addEventListener('mousemove', (e) => {
      if (isDragging) {
        let rect = container.getBoundingClientRect();
        let x = e.clientX - rect.left;
        if (x < 0) x = 0;
        if (x > stringLength) x = stringLength;
        // Snap aux crans (multiples de 50px)
        x = Math.round(x / snapStep) * snapStep;
        bridgeSvg.style.left = `${x - 12}px`;
        updateInfo(x);
        resetString();
      }
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
    });

    // Gestion du clic sur la corde
    stringSvg.addEventListener('click', (e) => {
      let rect = container.getBoundingClientRect();
      let clickX = e.clientX - rect.left;
      let bridgeX = parseFloat(bridgeSvg.style.left) + 12 || 0;
      if (clickX < bridgeX) {
        playLeftSide(clickX);
      } else {
        playRightSide(clickX);
      }
    });

    function updateInfo(x) {
      let ratio = x / stringLength;
      let leftRatio = ratio;
      let rightRatio = 1 - ratio;
      let interval = getIntervalName(leftRatio);
      info.textContent = `Position du chevalet : ${(ratio * 100).toFixed(1)}% (Côté gauche : ${interval}, Côté droit : ${getIntervalName(rightRatio)})`;
    }

    function getIntervalName(ratio) {
      if (Math.abs(ratio - 1) < 0.05) return 'Do (Fondamentale)';
      if (Math.abs(ratio - 0.75) < 0.05) return 'Fa (Quarte)';
      if (Math.abs(ratio - 2/3) < 0.05) return 'Sol (Quinte)';
      if (Math.abs(ratio - 0.5) < 0.05) return 'Do (Octave)';
      let fraction = Math.round(ratio * 12) / 12;
      let fractionStr = `${Math.round(ratio * 12)}/12`;
      return intervals[fractionStr] || 'Autre';
    }

    function playTone(frequency) {
      const oscillator = ctx.createOscillator();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(frequency, ctx.currentTime);
      oscillator.connect(ctx.destination);
      oscillator.start();
      oscillator.stop(ctx.currentTime + 1);
    }

    function vibrateString(start, end, duration = 2000) {
      if (start === end) return;
      let startTime = performance.now();
      let initialAmplitude = 40;
      let bridgeX = parseFloat(bridgeSvg.style.left) + 12 || 0;
      function animate(time) {
        let progress = (time - startTime) / duration;
        if (progress > 1) {
          resetString();
          return;
        }
        let envelope = Math.exp(-progress * 3);
        let phase = (time - startTime) * 0.05; // Vitesse augmentée pour plus de rapidité
        let sign = Math.sin(phase) >= 0 ? 1 : -1;
        let disp = initialAmplitude * sign * envelope;
        let midX = start + (end - start) / 2;
        let midY = 20 + disp;
        let controlX1 = start + (end - start) / 3;
        let controlX2 = start + 2 * (end - start) / 3;
        let path;
        if (end <= bridgeX) {
          // Segment gauche vibre, droit reste droit
          path = `M0 20 C${controlX1} ${midY} ${controlX2} ${midY} ${end} 20 L${bridgeX} 20 L${stringLength} 20`;
        } else {
          // Segment droit vibre, gauche reste droit
          path = `M0 20 L${bridgeX} 20 C${controlX1} ${midY} ${controlX2} ${midY} ${end} 20`;
        }
        stringPath.setAttribute('d', path);
        animationFrame = requestAnimationFrame(animate);
      }
      cancelAnimationFrame(animationFrame);
      animationFrame = requestAnimationFrame(animate);
    }

    function resetString() {
      cancelAnimationFrame(animationFrame);
      stringPath.setAttribute('d', `M0 20 H${stringLength}`);
    }

    function playLeftSide(clickX) {
      let x = parseFloat(bridgeSvg.style.left) + 12 || 0;
      if (x === 0) return;
      let ratio = x / stringLength;
      let freq = baseFreq / ratio;
      playTone(freq);
      vibrateString(0, x);
    }

    function playRightSide(clickX) {
      let x = parseFloat(bridgeSvg.style.left) + 12 || 0;
      let ratio = 1 - (x / stringLength);
      if (ratio === 0) return;
      let freq = baseFreq / ratio;
      playTone(freq);
      vibrateString(x, stringLength);
    }

    // Initialiser la position du chevalet
    bridgeSvg.style.left = '0px';
  </script>
</body>
</html>